<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Basic Struct</title>
</head>

<body>
    <p>Hello, WebAssembly!</p>

    <script>
        var memory = new WebAssembly.Memory({
            initial: 256,
            maximum: 512
        });

        var exports;
        WebAssembly.instantiateStreaming(fetch("basic_struct.wasm"), {
            js: {
                mem: memory
            },
            env: {
                emscripten_resize_heap: (delta) => memory.grow(delta)
            }
        }).then(results => {
            exports = results.instance.exports;
            memory = results.instance.exports.memory;
        });

        function alloc_struct() {
            var a = document.querySelector("#a").value;
            var b = document.querySelector("#b").value;

            var ptr = exports.createPair(a, b);
            var bytes = new Uint32Array(memory.buffer, ptr, 2);
            var struct_a = bytes[0];
            var struct_b = bytes[1];
            exports.wasmfree(ptr);

            var str = `${a}, ${b}`;
            console.log(str);
            document.querySelector("#ret")
                .innerHTML += `${str}<br>`;
        }

        function compute_sum() {
            var a = document.querySelector("#a").value;
            var b = document.querySelector("#b").value;
            var ptr = encodeArray([a, b], 2, 4);

            var sum = exports.sum(ptr);
            exports.wasmfree(ptr);

            console.log(sum);
            document.querySelector("#ret")
                .innerHTML += `${sum}<br>`;
        }

        function encodeArray(arr, len, sizeof = 1) {
            var ptr;
            var out;
            if (sizeof == 8) {
                ptr = exports.wasmmalloc(len * 8);
                out = new BigUint64Array(memory.buffer, ptr);
            }
            else if (sizeof == 4) {
                ptr = exports.wasmmalloc(len * 4);
                out = new Uint32Array(memory.buffer, ptr);
            }
            else {
                ptr = exports.wasmmalloc(len);
                out = new Uint8Array(memory.buffer, ptr);
            }

            for (var i = 0; i < len; i++) {
                out[i] = arr[i];
            }

            return ptr;
        }
    </script>

    <input type="number" id="a" />
    <input type="number" id="b" />
    <button onclick="alloc_struct()">Generate structure</button>
    <button onclick="compute_sum()">Compute sum</button>
    <p id="ret"></p>
</body>

</html>